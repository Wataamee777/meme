name: Build Media List

on:
  push:
    paths:
      - "upload/**"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ğŸ”¥ ã¾ãšéå»ã®ã‚´ãƒŸã‚’ Git ã® index ã‹ã‚‰å‰Šé™¤
      - name: Force clear thumbs from Git
        run: |
          git rm -r --cached thumbs || true
          rm -rf thumbs
          mkdir thumbs

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick

      - name: Prepare data dir
        run: mkdir -p data

      - name: Generate thumbnails & JSON
        run: |
          echo "[" > data/list.json
          first=true

          for f in upload/*; do
            [ -f "$f" ] || continue

            filename=$(basename "$f")
            base="${filename%.*}"
            ext="${filename##*.}"
            lower=$(echo "$ext" | tr 'A-Z' 'a-z')

            case "$lower" in
              jpg|jpeg|png|webp)
                convert "$f" -resize 300x300 "thumbs/${base}.jpg"
                ;;
              gif)
              # GIFã‚µãƒ ãƒç”Ÿæˆï¼ˆ100ãƒ•ãƒ¬â†’æœ€çµ‚â†’1ãƒ•ãƒ¬ fallbackï¼‰
                ffmpeg -y -i "$f" -vf "select=gte(n\,100),scale=300:-1" -vframes 1 "thumbs/${base}.jpg" 2>/dev/null
                if [ ! -s "thumbs/${base}.jpg" ]; then
                 ffmpeg -y -i "$f" -vf "select=gt(n\,3),scale=300:-1" -vframes 1 "thumbs/${base}.jpg" 2>/dev/null
                fi
                if [ ! -s "thumbs/${base}.jpg" ]; then
                 ffmpeg -y -i "$f" -vf "scale=300:-1" -vframes 1 "thumbs/${base}.jpg"
                fi
                ;;
              mp4|mov|webm|mkv)
                ffmpeg -y -i "$f" -vf "thumbnail,scale=300:-1" -frames:v 1 "thumbs/${base}.jpg"
                ;;
              mp3|wav|ogg|m4a)
                ffmpeg -y -i "$f" -filter_complex "showwavespic=s=300x300" \
                  -frames:v 1 "thumbs/${base}.jpg" \
                  || convert -size 300x300 xc:gray "thumbs/${base}.jpg"
                ;;
              *)
                echo "Skip unsupported: $filename"
                continue
                ;;
            esac

            if [ "$first" = true ]; then
              first=false
            else
              echo "," >> data/list.json
            fi

            echo "  {" >> data/list.json
            echo "    \"title\": \"$base\"," >> data/list.json
            echo "    \"file\": \"$filename\"," >> data/list.json
            echo "    \"thumb\": \"thumbs/${base}.jpg\"," >> data/list.json
            echo "    \"url\": \"upload/${filename}\"," >> data/list.json
            echo "    \"type\": \"$lower\"" >> data/list.json
            echo "  }" >> data/list.json
          done

          echo "]" >> data/list.json

      # ğŸ”¥ å‰Šé™¤ï¼‹ç”Ÿæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¨éƒ¨ Git ã«åæ˜ 
      - name: Commit changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add -A

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Regenerated JSON & thumbnails (cleaned)"
            git push
          fi
