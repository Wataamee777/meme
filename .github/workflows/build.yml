name: Build media list

# upload フォルダに変更があれば動く
on:
  push:
    paths:
      - "upload/**"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick

      - name: Prepare folders
        run: |
          mkdir -p thumbs data
          # ensure default music thumbnail exists (you should add default_music.jpg to repo root)
          if [ ! -f default_music.jpg ]; then
            echo "Please add default_music.jpg to repo root for audio thumbnails."
          fi

      - name: Generate thumbnails and collect metadata
        run: |
          # temp file to store JSON entries
          TMP=data/_entries.tmp
          : > $TMP

          for filepath in upload/*; do
            [ -e "$filepath" ] || continue
            filename=$(basename "$filepath")
            base="${filename%.*}"
            ext="${filename##*.}"
            lcext=$(echo "$ext" | tr '[:upper:]' '[:lower:]')

            thumb="thumbs/${base}.jpg"
            url="./upload/${filename}"
            thumb_rel="./thumbs/${base}.jpg"

            case "$lcext" in
              jpg|jpeg|png|gif|webp)
                # make square-ish thumb, keep aspect
                convert "$filepath" -auto-orient -resize 600x600\> -quality 85 "$thumb"
                ;;
              mp4|mov|webm|mkv)
                # extract a thumbnail frame (seek a bit into video to avoid black frames)
                ffmpeg -hide_banner -loglevel error -ss 2 -i "$filepath" -vf "thumbnail,scale=600:-1" -frames:v 1 "$thumb" || \
                  ffmpeg -hide_banner -loglevel error -i "$filepath" -vf "thumbnail,scale=600:-1" -frames:v 1 "$thumb" || \
                  cp default_video.jpg "$thumb" 2>/dev/null || true
                ;;
              mp3|wav|ogg|flac|m4a)
                # try to extract embedded cover image; if fail use default_music.jpg
                ffmpeg -hide_banner -loglevel error -i "$filepath" -an -vcodec copy "$thumb" 2>/dev/null || \
                  ffmpeg -hide_banner -loglevel error -i "$filepath" -y -frames:v 1 "$thumb" 2>/dev/null || \
                  cp default_music.jpg "$thumb" 2>/dev/null || true
                ;;
              *)
                echo "Skipping unknown file type: $filepath"
                continue
                ;;
            esac

            # sanitize title from filename (replace underscores/hyphens with spaces)
            title=$(echo "$base" | sed -E 's/[_-]+/ /g')

            # add entry (escape double quotes)
            title_esc=$(echo "$title" | sed 's/"/\\"/g')
            echo "  {\"title\": \"${title_esc}\", \"file\": \"${filename}\", \"thumb\": \"${thumb_rel}\", \"url\": \"${url}\", \"type\": \"${lcext}\" }," >> $TMP
          done

          # write final JSON (remove trailing comma)
          echo "[" > data/list.json
          if [ -s $TMP ]; then
            sed '$ s/,$//' $TMP >> data/list.json
          fi
          echo "]" >> data/list.json

      - name: Add index.html fallback (if not present)
        run: |
          if [ ! -f index.html ]; then
            echo "<!doctype html><meta charset='utf-8'><title>Meme Gallery</title><body><h1>Put index.html</h1></body></html>" > index.html
          fi

      - name: Commit thumbnails and list.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add data/list.json thumbs || true
          git commit -m "chore: update thumbs & data/list.json" || echo "No changes to commit"
          git push || echo "Push failed (maybe no changes)"
