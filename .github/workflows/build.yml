name: Build Media List

on:
  push:
    paths:
      - "upload/**"
  workflow_dispatch:

permissions:
  contents: write   # â† ã“ã‚ŒãŒç„¡ã„ã¨ push ä¸å¯èƒ½

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick

      - name: Prepare directories
        run: |
          mkdir -p thumbs
          mkdir -p data

      - name: Clear old thumbnails
        run: rm -f thumbs/* || true

      - name: Ensure default audio thumb exists
        run: |
          if [ ! -f default_music.jpg ]; then
            echo "No default_music.jpg found. Generating placeholder."
            convert -size 300x300 "xc:gray" -gravity center \
              -pointsize 48 -annotate 0 "Music" default_music.jpg
          fi

      - name: Generate thumbnails & JSON
        run: |
          echo "[" > data/list.json
          first=true

          for f in upload/*; do
            [ -f "$f" ] || continue

            filename=$(basename "$f")
            base="${filename%.*}"
            ext="${filename##*.}"
            lower=$(echo "$ext" | tr 'A-Z' 'a-z')

            echo "Processing: $filename"

            # ðŸ”¥ ã‚µãƒ ãƒç”Ÿæˆ
            case "$lower" in
              jpg|jpeg|png|gif|webp)
                convert "$f" -resize 300x300 "thumbs/${base}.jpg"
                ;;
              mp4|mov|webm|mkv)
                ffmpeg -y -i "$f" -vf "thumbnail,scale=300:-1" -frames:v 1 "thumbs/${base}.jpg"
                ;;
              mp3|wav|ogg|m4a)
                # éŸ³å£° â†’ æ³¢å½¢ã‚µãƒ ãƒç”Ÿæˆ
                ffmpeg -y -i "$f" -filter_complex "showwavespic=s=300x300:colors=white" -frames:v 1 "thumbs/${base}.jpg" \
                  || cp default_music.jpg "thumbs/${base}.jpg"
                ;;
              *)
                echo "Skip unsupported: $filename"
                continue
                ;;
            esac

            # ðŸ”¥ JSON è¿½åŠ 
            if [ "$first" = true ]; then
              first=false
            else
              echo "," >> data/list.json
            fi

            echo "  {" >> data/list.json
            echo "    \"title\": \"$base\"," >> data/list.json
            echo "    \"file\": \"$filename\"," >> data/list.json
            echo "    \"thumb\": \"/thumbs/${base}.jpg\"," >> data/list.json
            echo "    \"url\": \"/upload/${filename}\"," >> data/list.json
            echo "    \"type\": \"$lower\"" >> data/list.json
            echo "  }" >> data/list.json

          done

          echo "]" >> data/list.json

      - name: Commit changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add data/list.json thumbs/ || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Regenerated JSON & thumbnails"
            git push
          fi
